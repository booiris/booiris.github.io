<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.148.1"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://booiris.space/wiki/redis/1.1-sds%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2/"><link rel=canonical href=https://booiris.space/wiki/redis/1.1-sds%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2/><link rel=apple-touch-icon href=/avatar.svg><link rel=icon href=/avatar.svg><link rel=shortcut href=/avatar.svg><link rel=alternate type=application/atom+xml href=https://booiris.space/index.xml title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/booiris.space\/"},"articleSection":"wiki","name":"1.1 SDS(动态字符串)","headline":"1.1 SDS(动态字符串)","description":"SDS介绍 Redis自己构建了一种名为简单动态字符串(simple dynamic string, SDS) 的抽象类型，并将其作为Redis的默认字符串表示。\nSDS定义 在 Redis7.0 中 定义的代码位于 src\/sds.h 中，定义如下。\n\/* Note: sdshdr5 is never used, we just access the flags byte directly. * However is here to document the layout of type 5 SDS strings. *\/ struct __attribute__ ((__packed__)) sdshdr5 { unsigned char flags; \/* 3 lsb of type, and 5 msb of string length *\/ char buf[]; \/\/ 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr8 { uint8_t len; \/* used *\/ uint8_t alloc; \/* excluding the header and null terminator *\/ unsigned char flags; \/* 3 lsb of type, 5 unused bits *\/ char buf[]; \/\/ 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr16 { uint16_t len; \/* used *\/ uint16_t alloc; \/* excluding the header and null terminator *\/ unsigned char flags; \/* 3 lsb of type, 5 unused bits *\/ char buf[]; \/\/ 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr32 { uint32_t len; \/* used *\/ uint32_t alloc; \/* excluding the header and null terminator *\/ unsigned char flags; \/* 3 lsb of type, 5 unused bits *\/ char buf[]; \/\/ 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr64 { uint64_t len; \/* used *\/ uint64_t alloc; \/* excluding the header and null terminator *\/ unsigned char flags; \/* 3 lsb of type, 5 unused bits *\/ char buf[]; \/\/ 柔性数组 }; 根据字符串长度不同，用来存放它的sds类型也不同。\n","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2022","datePublished":"2022-09-24 21:14:26 \u002b0000 UTC","dateModified":"2022-09-24 21:14:26 \u002b0000 UTC","url":"https:\/\/booiris.space\/wiki\/redis\/1.1-sds%E5%8A%A8%E6%80%81%E5%AD%97%E7%AC%A6%E4%B8%B2\/","keywords":[]}</script><title>1.1 SDS(动态字符串)</title><meta property="og:title" content="1.1 SDS(动态字符串)"><meta property="og:type" content="article"><meta property="og:description" content="SDS介绍 Redis自己构建了一种名为简单动态字符串(simple dynamic string, SDS) 的抽象类型，并将其作为Redis的默认字符串表示。
SDS定义 在 Redis7.0 中 定义的代码位于 src/sds.h 中，定义如下。
/* Note: sdshdr5 is never used, we just access the flags byte directly. * However is here to document the layout of type 5 SDS strings. */ struct __attribute__ ((__packed__)) sdshdr5 { unsigned char flags; /* 3 lsb of type, and 5 msb of string length */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr8 { uint8_t len; /* used */ uint8_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr16 { uint16_t len; /* used */ uint16_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr32 { uint32_t len; /* used */ uint32_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr64 { uint64_t len; /* used */ uint64_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; 根据字符串长度不同，用来存放它的sds类型也不同。
"><meta name=description content="SDS介绍 Redis自己构建了一种名为简单动态字符串(simple dynamic string, SDS) 的抽象类型，并将其作为Redis的默认字符串表示。
SDS定义 在 Redis7.0 中 定义的代码位于 src/sds.h 中，定义如下。
/* Note: sdshdr5 is never used, we just access the flags byte directly. * However is here to document the layout of type 5 SDS strings. */ struct __attribute__ ((__packed__)) sdshdr5 { unsigned char flags; /* 3 lsb of type, and 5 msb of string length */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr8 { uint8_t len; /* used */ uint8_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr16 { uint16_t len; /* used */ uint16_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr32 { uint32_t len; /* used */ uint32_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; struct __attribute__ ((__packed__)) sdshdr64 { uint64_t len; /* used */ uint64_t alloc; /* excluding the header and null terminator */ unsigned char flags; /* 3 lsb of type, 5 unused bits */ char buf[]; // 柔性数组 }; 根据字符串长度不同，用来存放它的sds类型也不同。
"><meta property="og:locale" content="cn"><meta property="og:image" content="/avatar.svg"><link rel=stylesheet href=/css/index.min.css><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.min.css><link href=/%20index.xml rel=alternate type=application/rss+xml title><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css></head><body><article class="post cn" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>KEEP SEEKING</a></div><div class=header-subtitle>Live long and prosper.</div></header><div class="row end-md header-items"><div class=header-item><a href=/>Home</a></div><div class=header-item><a href=/about>About</a></div><div class=header-item><a href=https://github.com/booiris target=_blank>Github</a></div><div class=header-item><a href=/memos>Memos</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>1.1 SDS(动态字符串)</h1></header><div class="post-content markdown-body"><h2 id=sds介绍>SDS介绍</h2><p>Redis自己构建了一种名为简单动态字符串(simple dynamic string, SDS) 的抽象类型，并将其作为Redis的默认字符串表示。</p><h2 id=sds定义>SDS定义</h2><p>在 Redis7.0 中 定义的代码位于 <code>src/sds.h</code> 中，定义如下。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>/* Note: sdshdr5 is never used, we just access the flags byte directly.
</span></span></span><span style=display:flex><span><span style=color:#57606a> * However is here to document the layout of type 5 SDS strings. */</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#6639ba>__attribute__</span> <span style=color:#1f2328>((</span>__packed__<span style=color:#1f2328>))</span> sdshdr5 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags<span style=color:#1f2328>;</span> <span style=color:#57606a>/* 3 lsb of type, and 5 msb of string length */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>char</span> buf<span style=color:#1f2328>[];</span> <span style=color:#57606a>// 柔性数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#6639ba>__attribute__</span> <span style=color:#1f2328>((</span>__packed__<span style=color:#1f2328>))</span> sdshdr8 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint8_t</span> len<span style=color:#1f2328>;</span> <span style=color:#57606a>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint8_t</span> alloc<span style=color:#1f2328>;</span> <span style=color:#57606a>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags<span style=color:#1f2328>;</span> <span style=color:#57606a>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>char</span> buf<span style=color:#1f2328>[];</span> <span style=color:#57606a>// 柔性数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#6639ba>__attribute__</span> <span style=color:#1f2328>((</span>__packed__<span style=color:#1f2328>))</span> sdshdr16 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> len<span style=color:#1f2328>;</span> <span style=color:#57606a>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint16_t</span> alloc<span style=color:#1f2328>;</span> <span style=color:#57606a>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags<span style=color:#1f2328>;</span> <span style=color:#57606a>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>char</span> buf<span style=color:#1f2328>[];</span> <span style=color:#57606a>// 柔性数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#6639ba>__attribute__</span> <span style=color:#1f2328>((</span>__packed__<span style=color:#1f2328>))</span> sdshdr32 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> len<span style=color:#1f2328>;</span> <span style=color:#57606a>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint32_t</span> alloc<span style=color:#1f2328>;</span> <span style=color:#57606a>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags<span style=color:#1f2328>;</span> <span style=color:#57606a>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>char</span> buf<span style=color:#1f2328>[];</span> <span style=color:#57606a>// 柔性数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>struct</span> <span style=color:#6639ba>__attribute__</span> <span style=color:#1f2328>((</span>__packed__<span style=color:#1f2328>))</span> sdshdr64 <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> len<span style=color:#1f2328>;</span> <span style=color:#57606a>/* used */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>uint64_t</span> alloc<span style=color:#1f2328>;</span> <span style=color:#57606a>/* excluding the header and null terminator */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags<span style=color:#1f2328>;</span> <span style=color:#57606a>/* 3 lsb of type, 5 unused bits */</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>char</span> buf<span style=color:#1f2328>[];</span> <span style=color:#57606a>// 柔性数组
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>};</span>
</span></span></code></pre></div><p>根据字符串长度不同，用来存放它的sds类型也不同。</p><p>其中 <code>len</code> 表示使用的字符串长度，<code>alloc</code> 表示分配的总空间的长度，<code>flags</code> 表示当前结构体类型，因为只有五种类型，所以只使用低三位，有如下枚举值。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>#define SDS_TYPE_5  0
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define SDS_TYPE_8  1
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define SDS_TYPE_16 2
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define SDS_TYPE_32 3
</span></span></span><span style=display:flex><span><span style=color:#57606a>#define SDS_TYPE_64 4
</span></span></span></code></pre></div><p>结构前加上了 <code>__attribute__ ((__packed__))</code> 取消编译器的内存对齐<sup id=fnref:1><a href=#fn:1 class=footnote-ref role=doc-noteref>1</a></sup>。从图中可以看出，不同的数据类型有不同的对齐方式，<code>flags</code> 与 <code>buf</code> 存在填充数据，如果没有取消内存对齐， <code>(char*)buf - 1</code> 无法直接获取数据类型的 <code>flags</code>。</p><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img//20221006194934.png width=100%><p>SDS的内存分配方式详见 1.8 内存分配。</p><h2 id=接口定义>接口定义</h2><h3 id=字符串属性接口>字符串属性接口</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>// len 属性相关
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>size_t</span> <span style=color:#6639ba>sdslen</span><span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> sds s<span style=color:#1f2328>)</span> <span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>size_t</span> <span style=color:#6639ba>sdsavail</span><span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> sds s<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>sdssetlen</span><span style=color:#1f2328>(</span>sds s<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> newlen<span style=color:#1f2328>)</span> <span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>sdsinclen</span><span style=color:#1f2328>(</span>sds s<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> inc<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// alloc 属性相关
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#57606a>/* sdsalloc() = sdsavail() + sdslen() */</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>size_t</span> <span style=color:#6639ba>sdsalloc</span><span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> sds s<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>sdssetalloc</span><span style=color:#1f2328>(</span>sds s<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> newlen<span style=color:#1f2328>);</span>
</span></span></code></pre></div><h4 id=sdslen-接口><code>sdslen</code> 接口</h4><p><code>sdslen</code> 函数返回字符串的当前长度。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>size_t</span> <span style=color:#6639ba>sdslen</span><span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> sds s<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags <span style=color:#0550ae>=</span> s<span style=color:#1f2328>[</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>switch</span><span style=color:#1f2328>(</span>flags<span style=color:#0550ae>&amp;</span>SDS_TYPE_MASK<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_5</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#6639ba>SDS_TYPE_5_LEN</span><span style=color:#1f2328>(</span>flags<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_8</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>8</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_16</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>16</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_32</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>32</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_64</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>64</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p><code>sds</code> 由 <code>typedef char* sds;</code> 定义。可以看到，<code>sds</code> 实际上就是指向 sds 结构体的 buf 属性的指针。由于取消了内存对齐，<code>flags</code> 和 <code>buf</code> 中不含有填充数据，<code>(char *)buf - 1</code> 就是 flags的值。根据 <code>flags</code> 的值判断字符串</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#57606a>#define SDS_HDR(T,s) ((struct sdshdr##T *)((s)-(sizeof(struct sdshdr##T))))
</span></span></span></code></pre></div><h4 id=sdsavail-接口><code>sdsavail</code> 接口</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>size_t</span> <span style=color:#6639ba>sdsavail</span><span style=color:#1f2328>(</span><span style=color:#cf222e>const</span> sds s<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags <span style=color:#0550ae>=</span> s<span style=color:#1f2328>[</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>switch</span><span style=color:#1f2328>(</span>flags<span style=color:#0550ae>&amp;</span>SDS_TYPE_MASK<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_5</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_8</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR_VAR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>8</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> sh<span style=color:#0550ae>-&gt;</span>alloc <span style=color:#0550ae>-</span> sh<span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_16</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR_VAR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>16</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> sh<span style=color:#0550ae>-&gt;</span>alloc <span style=color:#0550ae>-</span> sh<span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_32</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR_VAR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>32</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> sh<span style=color:#0550ae>-&gt;</span>alloc <span style=color:#0550ae>-</span> sh<span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_64</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR_VAR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>64</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>return</span> sh<span style=color:#0550ae>-&gt;</span>alloc <span style=color:#0550ae>-</span> sh<span style=color:#0550ae>-&gt;</span>len<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#0550ae>0</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h4 id=sdssetlen-接口><code>sdssetlen</code> 接口</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>sdssetlen</span><span style=color:#1f2328>(</span>sds s<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> newlen<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags <span style=color:#0550ae>=</span> s<span style=color:#1f2328>[</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>switch</span><span style=color:#1f2328>(</span>flags<span style=color:#0550ae>&amp;</span>SDS_TYPE_MASK<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_5</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> <span style=color:#0550ae>*</span>fp <span style=color:#0550ae>=</span> <span style=color:#1f2328>((</span><span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span><span style=color:#0550ae>*</span><span style=color:#1f2328>)</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>*</span>fp <span style=color:#0550ae>=</span> SDS_TYPE_5 <span style=color:#0550ae>|</span> <span style=color:#1f2328>(</span>newlen <span style=color:#0550ae>&lt;&lt;</span> SDS_TYPE_BITS<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_8</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>8</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>=</span> newlen<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_16</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>16</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>=</span> newlen<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_32</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>32</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>=</span> newlen<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_64</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>64</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>=</span> newlen<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h4 id=sdsinclen-接口><code>sdsinclen</code> 接口</h4><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-c data-lang=c><span style=display:flex><span><span style=color:#cf222e>static</span> <span style=color:#cf222e>inline</span> <span style=color:#cf222e>void</span> <span style=color:#6639ba>sdsinclen</span><span style=color:#1f2328>(</span>sds s<span style=color:#1f2328>,</span> <span style=color:#cf222e>size_t</span> inc<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> flags <span style=color:#0550ae>=</span> s<span style=color:#1f2328>[</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>switch</span><span style=color:#1f2328>(</span>flags<span style=color:#0550ae>&amp;</span>SDS_TYPE_MASK<span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_5</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> <span style=color:#0550ae>*</span>fp <span style=color:#0550ae>=</span> <span style=color:#1f2328>((</span><span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span><span style=color:#0550ae>*</span><span style=color:#1f2328>)</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-</span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>                <span style=color:#cf222e>unsigned</span> <span style=color:#cf222e>char</span> newlen <span style=color:#0550ae>=</span> <span style=color:#6639ba>SDS_TYPE_5_LEN</span><span style=color:#1f2328>(</span>flags<span style=color:#1f2328>)</span><span style=color:#0550ae>+</span>inc<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>                <span style=color:#0550ae>*</span>fp <span style=color:#0550ae>=</span> SDS_TYPE_5 <span style=color:#0550ae>|</span> <span style=color:#1f2328>(</span>newlen <span style=color:#0550ae>&lt;&lt;</span> SDS_TYPE_BITS<span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_8</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>8</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>+=</span> inc<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_16</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>16</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>+=</span> inc<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_32</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>32</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>+=</span> inc<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>case</span> <span style=color:#900;font-weight:700>SDS_TYPE_64</span><span style=color:#1f2328>:</span>
</span></span><span style=display:flex><span>            <span style=color:#6639ba>SDS_HDR</span><span style=color:#1f2328>(</span><span style=color:#0550ae>64</span><span style=color:#1f2328>,</span>s<span style=color:#1f2328>)</span><span style=color:#0550ae>-&gt;</span>len <span style=color:#0550ae>+=</span> inc<span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>break</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><h2 id=参考链接>参考链接</h2><ol><li><a href=https://segmentfault.com/a/1190000041832335>c - Redis 源码解读——sds_个人文章 - SegmentFault 思否</a></li><li><a href=https://blog.csdn.net/czrzchao/article/details/78990345>redis源码解读(一):基础数据结构之SDS_czrzchao的博客-CSDN博客</a></li></ol><p>TODO:</p><p>定义##操作符</p><div class=footnotes role=doc-endnotes><hr><ol><li id=fn:1><p>如果没有预定义对齐值，那么结构体或者类的自身对齐值等于其成员中自身对齐值最大的那个值。&#160;<a href=#fnref:1 class=footnote-backref role=doc-backlink>&#8617;&#xfe0e;</a></p></li></ol></div></div><div class="row middle-xs"><div class=col-xs-12></div></div><div class=site-footer></div></div></div></article><script src=/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></body></html>