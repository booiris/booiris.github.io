<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://booiris.space/posts/blog/rust-for-screeps-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B/"><link rel=canonical href=https://booiris.space/posts/blog/rust-for-screeps-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B/><link rel=apple-touch-icon href=/avatar.svg><link rel=icon href=/avatar.svg><link rel=shortcut href=/avatar.svg><link rel=alternate type=application/atom+xml href=https://booiris.space/index.xml title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/booiris.space\/"},"articleSection":"posts","name":"Rust For Screeps (2): 自定义存储模型","headline":"Rust For Screeps (2): 自定义存储模型","description":"Screeps 存储模型 screeps 的存储模型基本如图所示。\n其中存在两种类型的 memory，一个是 memory object ，另一个是 raw memory 。\nmemory object memory object 的具体介绍在 Global Objects | Screeps Documentation。\nEach player has access to the global object Memory in which he\/she may store any information in the JSON format.\nMemory.someData = {...}; 可以看出 screeps 本身内置了一个 Memory 的对象实例。可以往其中添加各种属性来达到存储信息的目的。\nraw memory raw memory 在这里被提到 Global Objects | Screeps Documentation\nThe Memory object is stored in the stringified form and is parsed each time upon the first in the tick access from your script with the help of the JSON.parse method.\n","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2023","datePublished":"2023-07-22 21:05:20 \u002b0000 UTC","dateModified":"2023-07-22 21:05:20 \u002b0000 UTC","url":"https:\/\/booiris.space\/posts\/blog\/rust-for-screeps-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B\/","keywords":[]}</script><title>Rust For Screeps (2): 自定义存储模型</title><meta property="og:title" content="Rust For Screeps (2): 自定义存储模型"><meta property="og:type" content="article"><meta property="og:description" content="Screeps 存储模型 screeps 的存储模型基本如图所示。
其中存在两种类型的 memory，一个是 memory object ，另一个是 raw memory 。
memory object memory object 的具体介绍在 Global Objects | Screeps Documentation。
Each player has access to the global object Memory in which he/she may store any information in the JSON format.
Memory.someData = {...}; 可以看出 screeps 本身内置了一个 Memory 的对象实例。可以往其中添加各种属性来达到存储信息的目的。
raw memory raw memory 在这里被提到 Global Objects | Screeps Documentation
The Memory object is stored in the stringified form and is parsed each time upon the first in the tick access from your script with the help of the JSON.parse method.
"><meta name=description content="Screeps 存储模型 screeps 的存储模型基本如图所示。
其中存在两种类型的 memory，一个是 memory object ，另一个是 raw memory 。
memory object memory object 的具体介绍在 Global Objects | Screeps Documentation。
Each player has access to the global object Memory in which he/she may store any information in the JSON format.
Memory.someData = {...}; 可以看出 screeps 本身内置了一个 Memory 的对象实例。可以往其中添加各种属性来达到存储信息的目的。
raw memory raw memory 在这里被提到 Global Objects | Screeps Documentation
The Memory object is stored in the stringified form and is parsed each time upon the first in the tick access from your script with the help of the JSON.parse method.
"><meta property="og:locale" content="cn"><meta property="og:image" content="/avatar.svg"><link rel=stylesheet href=/css/index.min.css><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.min.css><link href=/%20index.xml rel=alternate type=application/rss+xml title><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>HELLO WORLD</a></div><div class=header-subtitle>Live long and prosper.</div></header><div class="row end-md header-items"><div class=header-item><a href=/about target=_blank>About</a></div><div class=header-item><a href=https://github.com/booiris target=_blank>Github</a></div><div class=header-item><a href=/memos target=_blank>Memos</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Rust For Screeps (2): 自定义存储模型</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2023-07-22 21:05:20 UTC">22 Jul 2023</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><h2 id=screeps-存储模型>Screeps 存储模型</h2><p>screeps 的存储模型基本如图所示。</p><p><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img//20230722224904.png alt=image.png></p><p>其中存在两种类型的 memory，一个是 <code>memory object</code> ，另一个是 <code>raw memory</code> 。</p><h3 id=memory-object>memory object</h3><p><code>memory object</code> 的具体介绍在 <a href=https://docs.screeps.com/global-objects.html#Memory-object>Global Objects | Screeps Documentation</a>。</p><blockquote><p>Each player has access to the global object <code>Memory</code> in which he/she may store any information in the JSON format.</p></blockquote><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#1f2328>Memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>someData</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{...};</span>
</span></span></code></pre></div><p>可以看出 screeps 本身内置了一个 <code>Memory</code> 的对象实例。可以往其中添加各种属性来达到存储信息的目的。</p><h3 id=raw-memory>raw memory</h3><p><code>raw memory</code> 在这里被提到 <a href=https://docs.screeps.com/global-objects.html#Serialization>Global Objects | Screeps Documentation</a></p><blockquote><p>The Memory object is stored in the stringified form and is parsed each time upon the first in the tick access from your script with the help of the <code>JSON.parse</code> method.</p></blockquote><p>可以看出 <code>Memory</code> 的对象实例最终会被序列化为字符串存储到 <code>raw memory</code> 中，在游戏的每个 tick 进行传递。</p><h3 id=存储传递过程>存储传递过程</h3><p>在游戏的进行每个 tick ，screeps 系统会反序列化 <code>raw memory</code> 到 <code>Memory Object</code> (代码见 <a href=https://github.com/screeps/engine/blob/c6c4fc9e656f160e0e0174b0dd9a817d2dd18976/src/game/game.js#L470>game.js</a>、<a href=https://github.com/screeps/engine/blob/c6c4fc9e656f160e0e0174b0dd9a817d2dd18976/src/game/game.js#L478C13-L478C76>game.js</a>)</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#1f2328>_</span><span style=color:#1f2328>.</span><span style=color:#1f2328>extend</span><span style=color:#1f2328>(</span><span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>globals</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>RawMemory</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>console</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>fakeConsole</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#6639ba>Object</span><span style=color:#1f2328>.</span><span style=color:#1f2328>defineProperty</span><span style=color:#1f2328>(</span><span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>globals</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#39;Memory&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>configurable</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>enumerable</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>get</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>try</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>			<span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>_parsed</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>JSON</span><span style=color:#1f2328>.</span><span style=color:#1f2328>parse</span><span style=color:#1f2328>(</span><span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>get</span><span style=color:#1f2328>()</span> <span style=color:#0550ae>||</span> <span style=color:#0a3069>&#34;{}&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>			<span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>_parsed</span><span style=color:#1f2328>.</span><span style=color:#1f2328>__proto__</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>catch</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>e</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>			<span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>_parsed</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#6639ba>Object</span><span style=color:#1f2328>.</span><span style=color:#1f2328>defineProperty</span><span style=color:#1f2328>(</span><span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>globals</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#39;Memory&#39;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>			<span style=color:#1f2328>configurable</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>			<span style=color:#1f2328>enumerable</span><span style=color:#0550ae>:</span> <span style=color:#cf222e>true</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>			<span style=color:#1f2328>value</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>_parsed</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>});</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#1f2328>runCodeCache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>userId</span><span style=color:#1f2328>].</span><span style=color:#1f2328>memory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>_parsed</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>});</span>
</span></span></code></pre></div><p>在每个 tick 最后，再将 <code>Memory</code> 序列化到 <code>raw memory</code> 里。所以，<strong>在每个 tick 间，真正传递的是 <code>raw memory</code></strong>。</p><h2 id=rust-存储模型>Rust 存储模型</h2><p>从上面可以知道，Screeps 有一个 JavaScript 对象 <code>Memory</code> 保存需要的信息。但是要从 rust 中访问 JavaScript 里的对象十分麻烦。同时 <a href=https://github.com/rustyscreeps/screeps-game-api/>screeps-game-api</a> 里似乎只有 <code>raw memory</code> 的获取方法，而没有 <code>memory</code> 对象的获取方法。</p><p>所以显然易见，我们的存储信息需要放到 rust 里。在上一章的示例代码中，有这样一个变量:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#57606a>// this is one way to persist data between ticks within Rust&#39;s memory, as opposed to
</span></span></span><span style=display:flex><span><span style=color:#57606a>// keeping state in memory on game objects - but will be lost on global resets!
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#6639ba>thread_local!</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>static</span><span style=color:#fff> </span><span style=color:#0550ae>CREEP_TARGETS</span>: <span style=color:#1f2328>RefCell</span><span style=color:#0550ae>&lt;</span>HashMap<span style=color:#0550ae>&lt;</span><span style=color:#6639ba>String</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>CreepTarget<span style=color:#0550ae>&gt;&gt;</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>RefCell::new<span style=color:#1f2328>(</span>HashMap::new<span style=color:#1f2328>());</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></div><p>我们可以使用 <code>RefCell</code> 创建一个全局变量 (类似 javaScript 里的 <code>Memory</code> 对象) 存储到 wasm 的线性内存里。只要 wasm 的实例没有被销毁，那么这个全局变量就可以随着 wasm 实例在每个 tick 传递。</p><h2 id=自定义存储实现>自定义存储实现</h2><p>通过 rust 的全局变量我们实现了信息跨 tick 存储，但注意到注释中存在着一句话。</p><blockquote><p>keeping state in memory on game objects - but will be lost on global resets!</p></blockquote><p>Screeps 系统存在着一个机制，就是 <code>global reset</code> ，会定时销毁 javaScript 里的对象并且重建，这就导致了这会销毁 wasm 的实例，进而导致存储的信息丢失。</p><h3 id=raw-memory-使用>raw memory 使用</h3><p>从第一部分可以知道 <code>raw memory</code> 可以认为是 Screeps 中的持久性存储。所以如果可以在每个 tick 最后把 rust 里的全局变量序列化到 <code>raw memory</code> 里，然后在 wasm 实例初始化时再从 <code>raw memory</code> 里反序列化回 rust 的全局变量，这就实现了信息的跨 tick 保存而又不会受到 <code>global reset</code> 的影响。</p><h3 id=rust-部分实现>rust 部分实现</h3><p>Screeps 的 api 存在对 <code>raw memory</code> 的操作方法 <a href=https://docs.screeps.com/api/#RawMemory>Screeps Documentation</a>。</p><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img//20230722234254.png width=65%><p>储存全局变量参考代码:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#6639ba>thread_local!</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>static</span><span style=color:#fff> </span><span style=color:#0550ae>GLOBAL_LONG_MEMORY</span>: <span style=color:#1f2328>RefCell</span><span style=color:#0550ae>&lt;</span>GlobalMemory<span style=color:#0550ae>&gt;</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>RefCell::new<span style=color:#1f2328>(</span>GlobalMemory::new<span style=color:#1f2328>());</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#0550ae>GLOBAL_LONG_MEMORY</span><span style=color:#1f2328>.</span>with<span style=color:#1f2328>(</span><span style=color:#0550ae>|</span>mem<span style=color:#0550ae>|</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>let</span><span style=color:#fff> </span>mem<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;*</span>mem<span style=color:#1f2328>.</span>borrow<span style=color:#1f2328>();</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>let</span><span style=color:#fff> </span>mem: <span style=color:#6639ba>String</span> <span style=color:#0550ae>=</span><span style=color:#fff> </span>mem<span style=color:#1f2328>.</span>into<span style=color:#1f2328>();</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span>raw_memory::set<span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>JsString::from_str<span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span>mem<span style=color:#1f2328>).</span>expect<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;can conver global mem to string&#34;</span><span style=color:#1f2328>))</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>});</span><span style=color:#fff>
</span></span></span></code></pre></div><p>其中 <code>GlobalMemory</code> 是一个结构体，并且实现了 <code>into String</code> 的方法，所以可以使用 <code>mem.into()</code> 转换为 <code>String</code> 类型，最后通过 api 的 <code>raw_memory::set</code> 方法将全局变量保存到 <code>raw memory</code> 中。</p><p>初始化全局变量参考代码:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#0550ae>GLOBAL_LONG_MEMORY</span><span style=color:#1f2328>.</span>with<span style=color:#1f2328>(</span><span style=color:#0550ae>|</span>mem<span style=color:#0550ae>|</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>let</span><span style=color:#fff> </span>raw_memory: <span style=color:#6639ba>String</span> <span style=color:#0550ae>=</span><span style=color:#fff> </span>raw_memory::get<span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>.</span>try_into<span style=color:#1f2328>()</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#1f2328>.</span>expect<span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;can not get raw memory&#34;</span><span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>if</span><span style=color:#fff> </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#6639ba>Ok</span><span style=color:#1f2328>(</span>raw_mem<span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>GlobalMemory::try_from<span style=color:#1f2328>(</span>raw_memory<span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0550ae>*</span>mem<span style=color:#1f2328>.</span>borrow_mut<span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>raw_mem<span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff> </span><span style=color:#cf222e>else</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span>log::<span style=color:#6639ba>error!</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;old mem can not match new struct!&#34;</span><span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>		</span><span style=color:#0550ae>*</span>mem<span style=color:#1f2328>.</span>borrow_mut<span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>GlobalMemory::new<span style=color:#1f2328>();</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>});</span><span style=color:#fff>
</span></span></span></code></pre></div><p>可以看出，<strong>存在无法从 <code>raw memory</code> 还原回全局变量的情况</strong> ( <code>GlobalMemory</code> 的结构出现了破坏性的更改导致无法从之前的结构反序列化回去)。这时候需要考虑构建一个在空的全局变量下还能继续运行并且还原的系统。</p><h3 id=javascript-部分实现>javaScript 部分实现</h3><p>本来存储 <code>raw memory</code> 的过程在 rust 中实现即可。但是存在一个问题，Screeps 系统运行中，某些动作 (比如 creep_move) 会使用的 <code>memory object</code> 实例，所以会对 <code>raw memory</code> 进行反序列化。为了不必要的消耗，我们可以持有一个 <code>mem_proxy</code> 对象实例，每个 tick 开始，就对 <code>memory object</code> 进行赋值，这样就不会触发反序列化，减少 cpu 消耗。</p><blockquote><p>参考 <a href=https://www.jianshu.com/p/c6413d67893b>Screeps游戏 Memory仙术 - 简书</a></p></blockquote><p>实现代码如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javaScript data-lang=javaScript><span style=display:flex><span><span style=color:#0a3069>&#34;use strict&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>wasm_module</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>const</span> <span style=color:#1f2328>MODULE_NAME</span> <span style=color:#0550ae>=</span> <span style=color:#0a3069>&#34;rust-screep-world&#34;</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>function</span> <span style=color:#1f2328>console_error</span><span style=color:#1f2328>(...</span><span style=color:#1f2328>args</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(...</span><span style=color:#1f2328>args</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>Game</span><span style=color:#1f2328>.</span><span style=color:#1f2328>notify</span><span style=color:#1f2328>(</span><span style=color:#1f2328>args</span><span style=color:#1f2328>.</span><span style=color:#1f2328>join</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39; &#39;</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>mem_proxy</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>{</span> <span style=color:#1f2328>creeps</span><span style=color:#0550ae>:</span> <span style=color:#1f2328>{}</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>module</span><span style=color:#1f2328>.</span><span style=color:#1f2328>exports</span><span style=color:#1f2328>.</span><span style=color:#1f2328>loop</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>delete</span> <span style=color:#1f2328>global</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Memory</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>global</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Memory</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>mem_proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>RawMemory</span><span style=color:#1f2328>.</span><span style=color:#1f2328>_parsed</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>mem_proxy</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>try</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>wasm_module</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>wasm_module</span><span style=color:#1f2328>.</span><span style=color:#1f2328>loop</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#57606a>// attempt to load the wasm only if there&#39;s enough bucket to do a bunch of work this tick
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>Game</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cpu</span><span style=color:#1f2328>.</span><span style=color:#1f2328>bucket</span> <span style=color:#0550ae>&lt;</span> <span style=color:#0550ae>500</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;we are running out of time, pausing compile!!!&#34;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>JSON</span><span style=color:#1f2328>.</span><span style=color:#1f2328>stringify</span><span style=color:#1f2328>(</span><span style=color:#1f2328>Game</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cpu</span><span style=color:#1f2328>));</span>
</span></span><span style=display:flex><span>                <span style=color:#cf222e>return</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>            <span style=color:#57606a>// delect the module from the cache, so we can reload it
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>MODULE_NAME</span> <span style=color:#cf222e>in</span> <span style=color:#1f2328>require</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cache</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>                <span style=color:#cf222e>delete</span> <span style=color:#1f2328>require</span><span style=color:#1f2328>.</span><span style=color:#1f2328>cache</span><span style=color:#1f2328>[</span><span style=color:#1f2328>MODULE_NAME</span><span style=color:#1f2328>];</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>            <span style=color:#57606a>// replace this initialize function on the module
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#1f2328>wasm_module</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>require</span><span style=color:#1f2328>(</span><span style=color:#1f2328>MODULE_NAME</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>            <span style=color:#57606a>// load the wasm instance!
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#1f2328>wasm_module</span><span style=color:#1f2328>.</span><span style=color:#1f2328>initialize_instance</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>            <span style=color:#57606a>// run the setup function, which configures logging
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#1f2328>wasm_module</span><span style=color:#1f2328>.</span><span style=color:#1f2328>setup</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>            <span style=color:#57606a>// go ahead and run the loop for its first tick
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>            <span style=color:#1f2328>wasm_module</span><span style=color:#1f2328>.</span><span style=color:#1f2328>loop</span><span style=color:#1f2328>();</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span> <span style=color:#cf222e>catch</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>error</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>console_error</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;caught exception err:&#34;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>error</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>error</span><span style=color:#1f2328>.</span><span style=color:#1f2328>stack</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>console_error</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;stack trace:&#34;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>error</span><span style=color:#1f2328>.</span><span style=color:#1f2328>stack</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>console_error</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;resetting VM next tick.&#34;</span><span style=color:#1f2328>);</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>wasm_module</span> <span style=color:#0550ae>=</span> <span style=color:#cf222e>null</span><span style=color:#1f2328>;</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>mem_proxy</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>global</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Memory</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/categories/screeps/>/screeps</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script src=/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></body></html>