<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://booiris.space/posts/blog/monad-%E7%B2%97%E6%B5%85%E4%BB%8B%E7%BB%8D/"><link rel=canonical href=https://booiris.space/posts/blog/monad-%E7%B2%97%E6%B5%85%E4%BB%8B%E7%BB%8D/><link rel=apple-touch-icon href=/avatar.svg><link rel=icon href=/avatar.svg><link rel=shortcut href=/avatar.svg><link rel=alternate type=application/atom+xml href=https://booiris.space/index.xml title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/booiris.space\/"},"articleSection":"posts","name":"monad 粗浅介绍","headline":"monad 粗浅介绍","description":"什么是 monad? monad(单子) 是函数式编程中的一种抽象，本文旨在对 monad 的粗浅介绍，所以跳过其数学上的定义和结构性证明(其实是目前笔者也不太懂🤫)，通过一些具体的例子说明它的概念和作用。\n定义 尽管没有太复杂的数学概念，但还是需要一个定义说明什么样的东西才能称之为 monad。在接下来的说明中，除了列举出数学定义以外，还有其在 go 语言中的具体表现形式。在 wiki 的定义中:\nMonad (functional programming) - Wikipedia\n一个 monad 包含三个部分:\n类型构造子 M 。\n在 go 中可以理解为一种名为 M 包裹着 T 的泛型结构体 M\u0026lt;T\u0026gt;{ val: T } 类型转换子 Unit :: T -\u0026gt; M T。\n在 go 中可以理解为由值 T 构造 M 的函数 func Unit[T any] (val T) -\u0026gt; M\u0026lt;T\u0026gt; 组合子 \u0026gt;\u0026gt;= or FlatMap :: M T -\u0026gt; ( T -\u0026gt; M U) -\u0026gt; M U 。\n","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2023","datePublished":"2023-12-12 21:20:47 \u002b0000 UTC","dateModified":"2023-12-12 21:20:47 \u002b0000 UTC","url":"https:\/\/booiris.space\/posts\/blog\/monad-%E7%B2%97%E6%B5%85%E4%BB%8B%E7%BB%8D\/","keywords":[]}</script><title>monad 粗浅介绍</title><meta property="og:title" content="monad 粗浅介绍"><meta property="og:type" content="article"><meta property="og:description" content="什么是 monad? monad(单子) 是函数式编程中的一种抽象，本文旨在对 monad 的粗浅介绍，所以跳过其数学上的定义和结构性证明(其实是目前笔者也不太懂🤫)，通过一些具体的例子说明它的概念和作用。
定义 尽管没有太复杂的数学概念，但还是需要一个定义说明什么样的东西才能称之为 monad。在接下来的说明中，除了列举出数学定义以外，还有其在 go 语言中的具体表现形式。在 wiki 的定义中:
Monad (functional programming) - Wikipedia
一个 monad 包含三个部分:
类型构造子 M 。
在 go 中可以理解为一种名为 M 包裹着 T 的泛型结构体 M<T>{ val: T } 类型转换子 Unit :: T -> M T。
在 go 中可以理解为由值 T 构造 M 的函数 func Unit[T any] (val T) -> M<T> 组合子 >>= or FlatMap :: M T -> ( T -> M U) -> M U 。
"><meta name=description content="什么是 monad? monad(单子) 是函数式编程中的一种抽象，本文旨在对 monad 的粗浅介绍，所以跳过其数学上的定义和结构性证明(其实是目前笔者也不太懂🤫)，通过一些具体的例子说明它的概念和作用。
定义 尽管没有太复杂的数学概念，但还是需要一个定义说明什么样的东西才能称之为 monad。在接下来的说明中，除了列举出数学定义以外，还有其在 go 语言中的具体表现形式。在 wiki 的定义中:
Monad (functional programming) - Wikipedia
一个 monad 包含三个部分:
类型构造子 M 。
在 go 中可以理解为一种名为 M 包裹着 T 的泛型结构体 M<T>{ val: T } 类型转换子 Unit :: T -> M T。
在 go 中可以理解为由值 T 构造 M 的函数 func Unit[T any] (val T) -> M<T> 组合子 >>= or FlatMap :: M T -> ( T -> M U) -> M U 。
"><meta property="og:locale" content="cn"><meta property="og:image" content="/avatar.svg"><link rel=stylesheet href=/css/index.min.css><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.min.css><link href=/%20index.xml rel=alternate type=application/rss+xml title><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>HELLO WORLD</a></div><div class=header-subtitle>Live long and prosper.</div></header><div class="row end-md header-items"><div class=header-item><a href=/about target=_blank>About</a></div><div class=header-item><a href=https://github.com/booiris target=_blank>Github</a></div><div class=header-item><a href=/memos target=_blank>Memos</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>monad 粗浅介绍</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2023-12-12 21:20:47 UTC">12 Dec 2023</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><h2 id=什么是-monad>什么是 monad?</h2><p>monad(单子) 是函数式编程中的一种抽象，本文旨在对 monad 的粗浅介绍，所以跳过其数学上的定义和结构性证明(其实是目前笔者也不太懂🤫)，通过一些具体的例子说明它的概念和作用。</p><h3 id=定义>定义</h3><p>尽管没有太复杂的数学概念，但还是需要一个定义说明什么样的东西才能称之为 monad。在接下来的说明中，除了列举出数学定义以外，还有其在 go 语言中的具体表现形式。在 wiki 的定义中:</p><blockquote><p><a href=https://en.wikipedia.org/wiki/Monad_%28functional_programming%29#Definition>Monad (functional programming) - Wikipedia</a></p></blockquote><p>一个 monad 包含三个部分:</p><ol><li><p>类型构造子 <code>M</code> 。</p><ul><li>在 go 中可以理解为一种名为 <code>M</code> 包裹着 <code>T</code> 的泛型结构体 <code>M&lt;T>{ val: T }</code></li></ul></li><li><p>类型转换子 <code>Unit :: T -> M T</code>。</p><ul><li>在 go 中可以理解为由值 <code>T</code> 构造 <code>M</code> 的函数 <code>func Unit[T any] (val T) -> M&lt;T></code></li></ul></li><li><p>组合子 <code>>>= or FlatMap :: M T -> ( T -> M U) -> M U</code> 。</p><ul><li>在 go 中可以理解为 <code>M&lt;T>{ val: T }</code> 这个结构体具有一个成员方法 <code>func flatMap[T, U any] (func(T) -> M&lt;U>) -> M&lt;U></code> ，能够接受一个函数参数实现从 <code>M&lt;T></code> 到 <code>M&lt;U></code> 的变换。</li></ul></li></ol><p>那么我们可以称这个具有 <code>FlatMap</code> 方法的 <strong>M</strong> 为一个 Monad (请注意不是 M&lt;\T> )。</p><h4 id=更严格的定义>更严格的定义</h4><p>一个 monad 还必须含有以下三个约束:</p><ol><li><p>转换子 <code>Unit</code> 是组合子 <code>>>=</code> 的左<a href=https://en.wikipedia.org/wiki/Identity_element>单位元</a>: <code>Unit >>= f &lt;-> f</code> 。</p><ul><li>在 go 中可以理解为：如果有一个函数为 <code>F[ T, U any] (T) M U</code>, 那么 <code>Unit(x).FlatMap(f)</code> 的执行结果和执行 <code>f(x)</code> 结果相同</li></ul></li><li><p>转换子 <code>Unit</code> 是组合子 <code>>>=</code> 的右<a href=https://en.wikipedia.org/wiki/Identity_element>单位元</a>: <code>f >>= Unit &lt;-> f</code></p><ul><li>在 go 中可以理解为：如果有一个函数为 <code>F[ T, U any] (T) M U</code>, <code>F(x).FlatMap(Unit)</code> 的执行结果等于 <code>F(x)</code></li></ul></li><li><p>组合子 <code>>>=</code> 满足结合律: <code>ma >>= λx -> (f(x) >>= λy -> g(y)) &lt;-> (ma >>= λx -> f(x)) >>= λy -> g(y)</code></p><ul><li>在 go 中可以理解为以下两个过程执行结果相等</li></ul></li></ol><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>F</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>U</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>](</span><span style=color:#1f2328>x</span> <span style=color:#1f2328>T</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>&lt;</span><span style=color:#1f2328>U</span><span style=color:#1f2328>&gt;</span>  <span style=color:#1f2328>{</span> <span style=color:#6639ba>f</span><span style=color:#1f2328>(</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>}</span> <span style=color:#57606a>// f(x) 是对 x 的一些行为</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>G</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>P</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>](</span><span style=color:#1f2328>y</span> <span style=color:#1f2328>U</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>&lt;</span><span style=color:#1f2328>P</span><span style=color:#1f2328>&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#6639ba>g</span><span style=color:#1f2328>(</span><span style=color:#1f2328>y</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>}</span> <span style=color:#57606a>// g(y) 是对 y 的一些行为</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>H</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>P</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>](</span><span style=color:#1f2328>x</span> <span style=color:#1f2328>T</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>&lt;</span><span style=color:#1f2328>P</span><span style=color:#1f2328>&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#6639ba>F</span><span style=color:#1f2328>(</span><span style=color:#1f2328>x</span><span style=color:#1f2328>).</span><span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>G</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>}</span> <span style=color:#57606a>// g(f(x))</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>res1</span> <span style=color:#0550ae>:=</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>{</span><span style=color:#1f2328>val</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>x</span><span style=color:#1f2328>}.</span><span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>H</span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>F</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>U</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>](</span><span style=color:#1f2328>x</span> <span style=color:#1f2328>T</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>&lt;</span><span style=color:#1f2328>U</span><span style=color:#1f2328>&gt;</span>  <span style=color:#1f2328>{</span> <span style=color:#6639ba>f</span><span style=color:#1f2328>(</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>}</span> <span style=color:#57606a>// f(x) 是对 x 的一些行为</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>G</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>P</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>](</span><span style=color:#1f2328>y</span> <span style=color:#1f2328>U</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>&lt;</span><span style=color:#1f2328>P</span><span style=color:#1f2328>&gt;</span> <span style=color:#1f2328>{</span> <span style=color:#6639ba>g</span><span style=color:#1f2328>(</span><span style=color:#1f2328>y</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>}</span> <span style=color:#57606a>// g(y) 是对 y 的一些行为</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>res2</span> <span style=color:#0550ae>:=</span> <span style=color:#1f2328>M</span><span style=color:#1f2328>{</span> <span style=color:#1f2328>val</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>x</span> <span style=color:#1f2328>}.</span><span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>F</span><span style=color:#1f2328>).</span><span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>G</span><span style=color:#1f2328>)</span>
</span></span></code></pre></div><h2 id=monad-有什么用>monad 有什么用?</h2><p>在列举完 monad 的定义后，为了避免陷在抽象的世界里无法自拔，笔者在接下来会具体列举一些例子说明 monad 的作用 。以笔者的观点来说，monad 的作用就是提供了一种隐藏副作用的形式，使得在编写处理函数的时候只用考虑预期的输入，将副作用延续到最后处理。</p><h3 id=另一个宇宙的-go-error-monad>另一个宇宙的 go error monad</h3><h4 id=引言>引言</h4><p>在 go 编程中，可能常见如下代码:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// 获取要查询的ID</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>GetID</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int64</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int64</span><span style=color:#1f2328>,</span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 获取 ID 对应的信息</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>GetInfo</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>id</span> <span style=color:#cf222e>int64</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>Info</span><span style=color:#1f2328>,</span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 获取上一个 Info 中 uid 对应的信息</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>GetUserInfo</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>Info</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>UserInfo</span><span style=color:#1f2328>,</span><span style=color:#cf222e>error</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>handle</span><span style=color:#1f2328>()</span> <span style=color:#cf222e>error</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>rawID</span> <span style=color:#0550ae>:=</span> <span style=color:#0550ae>0</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>id</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>err</span> <span style=color:#0550ae>:=</span> <span style=color:#6639ba>GetID</span><span style=color:#1f2328>(</span><span style=color:#1f2328>rawID</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>err</span> <span style=color:#0550ae>!=</span> <span style=color:#cf222e>nil</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#1f2328>err</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>info</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>err</span> <span style=color:#0550ae>:=</span> <span style=color:#6639ba>GetInfo</span><span style=color:#1f2328>(</span><span style=color:#1f2328>id</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>err</span> <span style=color:#0550ae>!=</span> <span style=color:#cf222e>nil</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#1f2328>err</span>
</span></span><span style=display:flex><span> 	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>userInfo</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>err</span> <span style=color:#0550ae>:=</span> <span style=color:#6639ba>GetUserInfo</span><span style=color:#1f2328>(</span><span style=color:#1f2328>info</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>err</span> <span style=color:#0550ae>!=</span> <span style=color:#cf222e>nil</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#1f2328>err</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// use userInfo ...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>可以看到 go 的灵魂出现了🤗</p><p><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img/20231224210233.png alt></p><p>当然笔者并不反对 go 这种严格处理每个函数返回的错误值的思想，不过本文既然是有关 monad 的介绍，自然是想着怎么将 monad 套用到 go 的错误处理中。</p><h4 id=go-版-monad-式错误处理>go 版 monad 式错误处理</h4><p>回顾 monad 的定义:</p><ul><li>首先 monad 是一个结构体:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>type</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>]</span> <span style=color:#cf222e>struct</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>Result</span> <span style=color:#1f2328>T</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>Err</span>  <span style=color:#cf222e>error</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>上面的结构体包含了返回值和错误。</p><ul><li>然后需要一个由 <code>T</code> 构造成 <code>M T</code> 的函数:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>Unit</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>result</span> <span style=color:#1f2328>T</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>return</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>]{</span>
</span></span><span style=display:flex><span>		<span style=color:#1f2328>Result</span><span style=color:#1f2328>:</span> <span style=color:#1f2328>result</span><span style=color:#1f2328>,</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><ul><li>有组合子 <code>FlatMap</code> 成员方法:</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>h</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>])</span> <span style=color:#1f2328>FlatMap</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>mapFunc</span> <span style=color:#cf222e>func</span><span style=color:#1f2328>(</span><span style=color:#1f2328>T</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>)</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>h</span><span style=color:#1f2328>.</span><span style=color:#1f2328>err</span> <span style=color:#0550ae>!=</span> <span style=color:#cf222e>nil</span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#1f2328>h</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>return</span> <span style=color:#6639ba>mapFunc</span><span style=color:#1f2328>(</span><span style=color:#1f2328>h</span><span style=color:#1f2328>.</span><span style=color:#1f2328>result</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>有了上述实现后，之前的流程就可以改写为:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#57606a>// 获取要查询的ID</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>GetID</span> <span style=color:#1f2328>(</span><span style=color:#cf222e>int64</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#cf222e>int64</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 获取 ID 对应的信息</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>GetInfo</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>id</span> <span style=color:#cf222e>int64</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>Info</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span><span style=color:#57606a>// 获取上一个 Info 中 uid 对应的信息</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>GetUserInfo</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>Info</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>ErrMonad</span><span style=color:#1f2328>[</span><span style=color:#1f2328>UserInfo</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>handle</span><span style=color:#1f2328>()</span> <span style=color:#cf222e>error</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>rawID</span> <span style=color:#0550ae>:=</span> <span style=color:#6639ba>Unit</span><span style=color:#1f2328>(</span><span style=color:#6639ba>int64</span><span style=color:#1f2328>(</span><span style=color:#0550ae>0</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>res</span> <span style=color:#0550ae>:=</span> <span style=color:#1f2328>rawID</span><span style=color:#1f2328>.</span>
</span></span><span style=display:flex><span>			<span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>GetID</span><span style=color:#1f2328>).</span>
</span></span><span style=display:flex><span>			<span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>GetInfo</span><span style=color:#1f2328>).</span>
</span></span><span style=display:flex><span>			<span style=color:#6639ba>FlatMap</span><span style=color:#1f2328>(</span><span style=color:#1f2328>GetUserInfo</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>	<span style=color:#cf222e>if</span> <span style=color:#1f2328>res</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Err</span> <span style=color:#0550ae>!=</span> <span style=color:#cf222e>nil</span><span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>		<span style=color:#cf222e>return</span> <span style=color:#1f2328>res</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Err</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>userInfo</span> <span style=color:#1f2328>=</span> <span style=color:#1f2328>res</span><span style=color:#1f2328>.</span><span style=color:#1f2328>Result</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// use userInfo ...</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>可以看出相较于之前的版本，代码更简洁了一些 (至少少了 <code>if err != nil { return err }</code>)。</p><p>然而理想是美好的，看着 monad 实现这么简单，为啥群友总说 go 不支持 monad 呢。回看本节标题 &ldquo;<strong>另一个宇宙</strong>的 go error monad&rdquo;，非常遗憾的是，目前的 go 不支持<strong>泛型方法参数</strong> <a href=https://go.googlesource.com/proposal/+/master/design/43651-type-parameters.md#no-parameterized-methods>Type Parameters Proposal</a>，<a href=/posts/blog/%E4%B8%BA%E5%95%A5-go-%E4%B8%8D%E6%94%AF%E6%8C%81%E6%B3%9B%E5%9E%8B%E6%96%B9%E6%B3%95/>为啥 go 不支持泛型方法</a>。具体来说就是不支持入参是一个带泛型的方法，即以下函数都是无法实现的:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#6639ba>goIsBest</span><span style=color:#1f2328>(</span> <span style=color:#cf222e>func</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>()</span> <span style=color:#1f2328>)</span> <span style=color:#cf222e>bool</span> <span style=color:#1f2328>{</span> <span style=color:#cf222e>return</span> <span style=color:#cf222e>false</span> <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#cf222e>type</span> <span style=color:#1f2328>GGGGGG</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>]</span> <span style=color:#cf222e>struct</span><span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>GGGGGG</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>])</span> <span style=color:#6639ba>gggggggggggg</span><span style=color:#1f2328>(</span> <span style=color:#cf222e>func</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>()</span> <span style=color:#1f2328>)</span> <span style=color:#1f2328>{}</span>
</span></span><span style=display:flex><span><span style=color:#cf222e>func</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>GGGGGG</span><span style=color:#1f2328>[</span><span style=color:#1f2328>T</span><span style=color:#1f2328>])</span> <span style=color:#1f2328>gggggggggggg</span><span style=color:#1f2328>[</span><span style=color:#1f2328>U</span> <span style=color:#cf222e>any</span><span style=color:#1f2328>]</span> <span style=color:#1f2328>()</span> <span style=color:#1f2328>{}</span>
</span></span></code></pre></div><p>摆个 issue 做参考(希望未来会有解决方法吧):</p><p><a href=https://github.com/golang/go/issues/49085>proposal: spec: allow type parameters in methods · Issue #49085 · golang/go · GitHub</a></p><p>这就导致了 <code>FlatMap</code> 方法是不可行的。至此，go 的 monad 之旅到此结束。</p><p>附一篇经典的错误处理方法 blog ( 感觉就像一种青春版的 monad，在所举的例子中存在类型只有 io.Writer，所以只用在单个类型里打转，省略了由 T 类型到 U 类型的转换，所以这种形式可以在 go 中实现:</p><p><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img/20240118232621.png alt></p><p><a href=https://go.dev/blog/errors-are-values>Errors are values - Thttps://go.dev/blog/errors-are-valueshe Go Programming Language</a></p><p><a href=https://zhuanlan.zhihu.com/p/548515367>if err != nil 太烦？Go 创始人教你如何对错误进行编程！ - 知乎</a> (<del>评论区</del>)</p><h3 id=monad-如何解决回调地狱>monad 如何解决回调地狱</h3><p>现在让我们来看看一点<del>老</del>(不新又不老)的东西。</p><h4 id=引言-1>引言</h4><p>各位即使没写过 javascript，也可能听说过<a href=http://callbackhell.com/>回调地狱</a>这个概念，具体来讲这是一种 javascript 异步编程中出现的一种现象。拿<a href=http://callbackhell.com/>Callback Hell</a>中的例子举例吧:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#1f2328>fs</span><span style=color:#1f2328>.</span><span style=color:#1f2328>readdir</span><span style=color:#1f2328>(</span><span style=color:#1f2328>source</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>function</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>files</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>  <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;Error finding files: &#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>err</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>files</span><span style=color:#1f2328>.</span><span style=color:#1f2328>forEach</span><span style=color:#1f2328>(</span><span style=color:#cf222e>function</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>filename</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>fileIndex</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>      <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#1f2328>filename</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>      <span style=color:#1f2328>gm</span><span style=color:#1f2328>(</span><span style=color:#1f2328>source</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>filename</span><span style=color:#1f2328>).</span><span style=color:#1f2328>size</span><span style=color:#1f2328>(</span><span style=color:#cf222e>function</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>values</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>        <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>          <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;Error identifying file size: &#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>err</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span> <span style=color:#cf222e>else</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>          <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#1f2328>filename</span> <span style=color:#0550ae>+</span> <span style=color:#0a3069>&#39; : &#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>values</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>          <span style=color:#1f2328>aspect</span> <span style=color:#0550ae>=</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>values</span><span style=color:#1f2328>.</span><span style=color:#1f2328>width</span> <span style=color:#0550ae>/</span> <span style=color:#1f2328>values</span><span style=color:#1f2328>.</span><span style=color:#1f2328>height</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>          <span style=color:#1f2328>widths</span><span style=color:#1f2328>.</span><span style=color:#1f2328>forEach</span><span style=color:#1f2328>(</span><span style=color:#cf222e>function</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>width</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>widthIndex</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>height</span> <span style=color:#0550ae>=</span> <span style=color:#6639ba>Math</span><span style=color:#1f2328>.</span><span style=color:#1f2328>round</span><span style=color:#1f2328>(</span><span style=color:#1f2328>width</span> <span style=color:#0550ae>/</span> <span style=color:#1f2328>aspect</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;resizing &#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>filename</span> <span style=color:#0550ae>+</span> <span style=color:#0a3069>&#39;to &#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>height</span> <span style=color:#0550ae>+</span> <span style=color:#0a3069>&#39;x&#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>height</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#cf222e>this</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resize</span><span style=color:#1f2328>(</span><span style=color:#1f2328>width</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>height</span><span style=color:#1f2328>).</span><span style=color:#1f2328>write</span><span style=color:#1f2328>(</span><span style=color:#1f2328>dest</span> <span style=color:#0550ae>+</span> <span style=color:#0a3069>&#39;w&#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>width</span> <span style=color:#0550ae>+</span> <span style=color:#0a3069>&#39;_&#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>filename</span><span style=color:#1f2328>,</span> <span style=color:#cf222e>function</span><span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>              <span style=color:#cf222e>if</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>err</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#39;Error writing file: &#39;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>err</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>            <span style=color:#1f2328>})</span>
</span></span><span style=display:flex><span>          <span style=color:#1f2328>}.</span><span style=color:#1f2328>bind</span><span style=color:#1f2328>(</span><span style=color:#cf222e>this</span><span style=color:#1f2328>))</span>
</span></span><span style=display:flex><span>        <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>      <span style=color:#1f2328>})</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>})</span>
</span></span><span style=display:flex><span>  <span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>})</span>
</span></span></code></pre></div><p>上面的代码具体作用就是异步执行如下操作: 通过传入的 <code>srouce</code> 读取指定目录下的文件列表，然后使用 <code>gm</code> 函数进行图像处理，保存处理后的图像到目标目录。</p><p>可以看到代码的嵌套层级非常深，这就是早期 javascript 异步编程的问题。对于异步函数，需要传入一个回调函数表明在当前状态结束后 (如读取文件结束后) 应该继续执行的动作。可以想象一旦异步处理过程多了，如果没有合适的方法，必然会导致深层次的函数嵌套。一般的做法就是将嵌套的函数抽出来，将异步调用拆解到每个函数中：</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#1f2328>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>a</span><span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>b</span><span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>c</span> <span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>)))</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a>// -------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>
</span></span><span style=display:flex><span><span style=color:#1f2328>main</span><span style=color:#1f2328>()</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#1f2328>a</span><span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>B</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>B</span><span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// do something
</span></span></span><span style=display:flex><span><span style=color:#57606a></span>	<span style=color:#1f2328>b</span><span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>c</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#1f2328>c</span><span style=color:#1f2328>(</span><span style=color:#1f2328>value</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>	<span style=color:#57606a>// do something
</span></span></span><span style=display:flex><span><span style=color:#57606a></span><span style=color:#1f2328>}</span>
</span></span></code></pre></div><p>但上述做法带来的一个小问题是如果需要了解整个运行的流程，需要不断跳转函数才能知道整个运行逻辑，而不能直接在一个 main 函数中知晓。</p><h4 id=异步和-monad>异步和 monad</h4><p>上述问题的根本原因在于异步过</p><h4 id=promise-介绍>promise 介绍</h4><p>在 2015 年后，promise 的出现缓解了 javascript 在异步编程中的问题，首先介绍一下什么是 promise:</p><ul><li>promise 是 javascript 中的一个对象，通过 <code>Promise.resolve</code> 方法可以构造出一个 promise 对象。</li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>x</span> <span style=color:#0550ae>=</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolve</span><span style=color:#1f2328>(</span><span style=color:#0550ae>123</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#57606a>// Promise { 123 }
</span></span></span></code></pre></div><ul><li><p>promise 内部有三种状态 <code>pending</code> 、<code>fulfilled</code> 和 <code>rejected</code> 。他们的作用在这里不深究，只要粗略地了解： <code>fulfilled</code> 可以认为是方法执行成功的状态，<code>rejected</code> 可以认为是方法返回 error 的状态。</p></li><li><p>promise 有三个成员方法 <code>then</code> ，<code>catch</code> 和 <code>finally</code>。这里只介绍 <code>then</code> 和 <code>catch</code> 方法。</p></li></ul><p><code>then</code> 方法接受两个类型为函数的参数，一个是当状态为 <code>fulfilled</code> 的时候调用，另一个为 <code>rejected</code> 的时候调用。一般来说，笔者喜欢只传前一个参数，第二个参数使用缺省值，即只有在状态为成功的时候才执行传入的函数。具体代码例子如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>x</span> <span style=color:#0550ae>=</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolve</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;now&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>x</span><span style=color:#1f2328>.</span><span style=color:#1f2328>then</span><span style=color:#1f2328>((</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;pre: &#34;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>x</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;running 1&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolve</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;run1&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>})</span>
</span></span></code></pre></div><p>和 <code>then</code> 类似，<code>catch</code> 方法接受一个类型为函数的参数，当状态为 <code>rejected</code> 会调用，具体代码例子如下:</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>x</span> <span style=color:#0550ae>=</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>reject</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;now&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>x</span><span style=color:#1f2328>.</span><span style=color:#cf222e>catch</span><span style=color:#1f2328>((</span><span style=color:#1f2328>reason</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;break at &#34;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>reason</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>})</span>
</span></span></code></pre></div><h4 id=promise-和-monad>promise 和 monad</h4><p>在了解了 promise 的概念后，可以看出 promise 非常像一个 monad。下面来点证明：</p><ul><li><p>类型构造子：Promise &lt; T ></p></li><li><p>类型转换子：Promise.resolve</p></li><li><p>组合子：Promise&lt; T >.then( (value: T) => U )</p></li></ul><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-javascript data-lang=javascript><span style=display:flex><span><span style=color:#cf222e>let</span> <span style=color:#1f2328>x</span> <span style=color:#0550ae>=</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolve</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;now&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>x</span><span style=color:#1f2328>.</span><span style=color:#1f2328>then</span><span style=color:#1f2328>((</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;pre: &#34;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>x</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;run1&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolve</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;run1&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}).</span><span style=color:#1f2328>then</span><span style=color:#1f2328>((</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;pre: &#34;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>x</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;run2&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>reject</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;run2&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}).</span><span style=color:#1f2328>then</span><span style=color:#1f2328>((</span><span style=color:#1f2328>x</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;pre: &#34;</span><span style=color:#1f2328>,</span> <span style=color:#1f2328>x</span><span style=color:#1f2328>,</span> <span style=color:#0a3069>&#34;run3&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span>    <span style=color:#cf222e>return</span> <span style=color:#6639ba>Promise</span><span style=color:#1f2328>.</span><span style=color:#1f2328>resolve</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;run3&#34;</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>}).</span><span style=color:#cf222e>catch</span><span style=color:#1f2328>((</span><span style=color:#1f2328>reason</span><span style=color:#1f2328>)</span> <span style=color:#1f2328>=&gt;</span> <span style=color:#1f2328>{</span>
</span></span><span style=display:flex><span>    <span style=color:#1f2328>console</span><span style=color:#1f2328>.</span><span style=color:#1f2328>log</span><span style=color:#1f2328>(</span><span style=color:#0a3069>&#34;break at &#34;</span> <span style=color:#0550ae>+</span> <span style=color:#1f2328>reason</span><span style=color:#1f2328>)</span>
</span></span><span style=display:flex><span><span style=color:#1f2328>})</span>
</span></span><span style=display:flex><span><span style=color:#57606a>/*
</span></span></span><span style=display:flex><span><span style=color:#57606a>Promise { &#39;now&#39; }
</span></span></span><span style=display:flex><span><span style=color:#57606a>pre:  now run1
</span></span></span><span style=display:flex><span><span style=color:#57606a>pre:  run1 run2
</span></span></span><span style=display:flex><span><span style=color:#57606a>break at run2
</span></span></span><span style=display:flex><span><span style=color:#57606a>*/</span>
</span></span></code></pre></div><h2 id=总结>总结</h2><h2 id=相关阅读>相关阅读</h2><ul><li><p><a href=https://www.bilibili.com/video/BV17E411F7cH/>Haskell Monad_哔哩哔哩_bilibili</a></p></li><li><p><a href=https://www.adit.io/posts/2013-04-17-functors,_applicatives,_and_monads_in_pictures.html>Functors, Applicatives, And Monads In Pictures - adit.io</a></p></li><li><p><a href=https://zhuanlan.zhihu.com/p/579141325>如何自底向上地建立起对 Monad 的理解 - 知乎</a></p></li><li><p><a href=https://www.zhihu.com/question/19635359/answer/62415213>什么是 Monad (Functional Programming)？ - Belleve的回答 - 知乎 🤣</a></p></li><li><p><a href=https://tech.meituan.com/2022/10/13/dive-into-functional-programming-01.html>深入理解函数式编程（上） - 美团技术团队</a></p></li><li><p><a href=https://tech.meituan.com/2022/10/13/dive-into-functional-programming-02.html>深入理解函数式编程（下） - 美团技术团队</a></p></li><li><p><a href=https://zh.wikipedia.org/wiki/Future%E4%B8%8Epromise>Future与promise - 维基百科，自由的百科全书</a></p></li></ul></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/categories/blog/>blog</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script src=/%20js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread"),t=new MutationObserver(function(n){n.forEach(function(){const s=e.getElementsByTagName("iframe");if(s.length>1){const n=s[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(n),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script></body></html>