<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://booiris.space/posts/blog/rust-for-screeps-3-%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/"><link rel=canonical href=https://booiris.space/posts/blog/rust-for-screeps-3-%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7/><link rel=apple-touch-icon href=/avatar.svg><link rel=icon href=/avatar.svg><link rel=shortcut href=/avatar.svg><link rel=alternate type=application/atom+xml href=https://booiris.space/index.xml title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/booiris.space\/"},"articleSection":"posts","name":"Rust For Screeps (3): 系统监控","headline":"Rust For Screeps (3): 系统监控","description":" 参考 Screeps 制作统计图表 - 简书\n首先说明: 本文使用 docker 将监控系统部署在自有服务器上，所以先决条件是一台能公网访问的服务器(\n整体流程 具体实现 记录当前状态存入内存 在 Screeps 制作统计图表 - 简书 中使用的是 memory object 存储系统信息。遗憾的是在 rust 中无法使用 memory 对象，但是 screeps 还有另一个存储信息的地方，那就是 raw memory 。\nraw memory 可以存储 10 MB 的序列化后的内容，它由一个个 segment 组成，每个segment 最多存储 100 KB 内容。所以可以指定一段 segment 用于存储当前系统的状态。\nfn log(\u0026amp;self) { let status_segement = raw_memory::segments(); let status = Status::get_status(); status_segement.set(STATUS_INDEX, status.into()); } 访问内存并解析内存内容 GitHub - booiris\/rust-learning at screep_log\n将信息存储到时序数据库中 使用 Grafana 制作图表 version: \u0026#39;2\u0026#39; services: sync: restart: unless-stopped build: context: .\/sync dockerfile: Dockerfile image: sync:1 volumes: - .\/sync\/log:\/log depends_on: - influxdb # https:\/\/hub.docker.com\/_\/influxdb 查看参数含义 influxdb: image: influxdb:latest restart: unless-stopped volumes: - .\/influxdb-data:\/var\/lib\/influxdb2 - .\/influxdb-config:\/etc\/influxdb2 environment: - DOCKER_INFLUXDB_INIT_MODE=setup - DOCKER_INFLUXDB_INIT_USERNAME=${username} - DOCKER_INFLUXDB_INIT_PASSWORD=${pwd} - DOCKER_INFLUXDB_INIT_ORG=${org} - DOCKER_INFLUXDB_INIT_BUCKET=${bucket} # https:\/\/grafana.com\/docs\/grafana\/latest\/setup-grafana\/installation\/docker\/ 查看参数含义 grafana: image: grafana\/grafana:latest restart: unless-stopped ports: - \u0026#39;12002:3000\u0026#39; volumes: - .\/grafana-data:\/var\/lib\/grafana - .\/grafana-provisioning\/:\/etc\/grafana\/provisioning depends_on: - influxdb user: \u0026#34;$UID:$GID\u0026#34; environment: - GF_SECURITY_ADMIN_USER=${GRAFANA_USERNAME} - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD} ","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2023","datePublished":"2023-07-22 23:35:45 \u002b0000 UTC","dateModified":"2023-07-22 23:35:45 \u002b0000 UTC","url":"https:\/\/booiris.space\/posts\/blog\/rust-for-screeps-3-%E7%B3%BB%E7%BB%9F%E7%9B%91%E6%8E%A7\/","keywords":[]}</script><title>Rust For Screeps (3): 系统监控</title><meta property="og:title" content="Rust For Screeps (3): 系统监控"><meta property="og:type" content="article"><meta property="og:description" content=" 参考 Screeps 制作统计图表 - 简书
首先说明: 本文使用 docker 将监控系统部署在自有服务器上，所以先决条件是一台能公网访问的服务器(
整体流程 具体实现 记录当前状态存入内存 在 Screeps 制作统计图表 - 简书 中使用的是 memory object 存储系统信息。遗憾的是在 rust 中无法使用 memory 对象，但是 screeps 还有另一个存储信息的地方，那就是 raw memory 。
raw memory 可以存储 10 MB 的序列化后的内容，它由一个个 segment 组成，每个segment 最多存储 100 KB 内容。所以可以指定一段 segment 用于存储当前系统的状态。
fn log(&amp;self) { let status_segement = raw_memory::segments(); let status = Status::get_status(); status_segement.set(STATUS_INDEX, status.into()); } 访问内存并解析内存内容 GitHub - booiris/rust-learning at screep_log
将信息存储到时序数据库中 使用 Grafana 制作图表 version: '2' services: sync: restart: unless-stopped build: context: ./sync dockerfile: Dockerfile image: sync:1 volumes: - ./sync/log:/log depends_on: - influxdb # https://hub.docker.com/_/influxdb 查看参数含义 influxdb: image: influxdb:latest restart: unless-stopped volumes: - ./influxdb-data:/var/lib/influxdb2 - ./influxdb-config:/etc/influxdb2 environment: - DOCKER_INFLUXDB_INIT_MODE=setup - DOCKER_INFLUXDB_INIT_USERNAME=${username} - DOCKER_INFLUXDB_INIT_PASSWORD=${pwd} - DOCKER_INFLUXDB_INIT_ORG=${org} - DOCKER_INFLUXDB_INIT_BUCKET=${bucket} # https://grafana.com/docs/grafana/latest/setup-grafana/installation/docker/ 查看参数含义 grafana: image: grafana/grafana:latest restart: unless-stopped ports: - '12002:3000' volumes: - ./grafana-data:/var/lib/grafana - ./grafana-provisioning/:/etc/grafana/provisioning depends_on: - influxdb user: &#34;$UID:$GID&#34; environment: - GF_SECURITY_ADMIN_USER=${GRAFANA_USERNAME} - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD} "><meta name=description content=" 参考 Screeps 制作统计图表 - 简书
首先说明: 本文使用 docker 将监控系统部署在自有服务器上，所以先决条件是一台能公网访问的服务器(
整体流程 具体实现 记录当前状态存入内存 在 Screeps 制作统计图表 - 简书 中使用的是 memory object 存储系统信息。遗憾的是在 rust 中无法使用 memory 对象，但是 screeps 还有另一个存储信息的地方，那就是 raw memory 。
raw memory 可以存储 10 MB 的序列化后的内容，它由一个个 segment 组成，每个segment 最多存储 100 KB 内容。所以可以指定一段 segment 用于存储当前系统的状态。
fn log(&amp;self) { let status_segement = raw_memory::segments(); let status = Status::get_status(); status_segement.set(STATUS_INDEX, status.into()); } 访问内存并解析内存内容 GitHub - booiris/rust-learning at screep_log
将信息存储到时序数据库中 使用 Grafana 制作图表 version: '2' services: sync: restart: unless-stopped build: context: ./sync dockerfile: Dockerfile image: sync:1 volumes: - ./sync/log:/log depends_on: - influxdb # https://hub.docker.com/_/influxdb 查看参数含义 influxdb: image: influxdb:latest restart: unless-stopped volumes: - ./influxdb-data:/var/lib/influxdb2 - ./influxdb-config:/etc/influxdb2 environment: - DOCKER_INFLUXDB_INIT_MODE=setup - DOCKER_INFLUXDB_INIT_USERNAME=${username} - DOCKER_INFLUXDB_INIT_PASSWORD=${pwd} - DOCKER_INFLUXDB_INIT_ORG=${org} - DOCKER_INFLUXDB_INIT_BUCKET=${bucket} # https://grafana.com/docs/grafana/latest/setup-grafana/installation/docker/ 查看参数含义 grafana: image: grafana/grafana:latest restart: unless-stopped ports: - '12002:3000' volumes: - ./grafana-data:/var/lib/grafana - ./grafana-provisioning/:/etc/grafana/provisioning depends_on: - influxdb user: &#34;$UID:$GID&#34; environment: - GF_SECURITY_ADMIN_USER=${GRAFANA_USERNAME} - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD} "><meta property="og:locale" content="cn"><meta property="og:image" content="/avatar.svg"><link rel=stylesheet href=/css/index.min.css><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.min.css><link href=/%20index.xml rel=alternate type=application/rss+xml title><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>HELLO WORLD</a></div><div class=header-subtitle>Live long and prosper.</div></header><div class="row end-md header-items"><div class=header-item><a href=/about target=_blank>About</a></div><div class=header-item><a href=https://github.com/booiris target=_blank>Github</a></div><div class=header-item><a href=/memos target=_blank>Memos</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>Rust For Screeps (3): 系统监控</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2023-07-22 23:35:45 UTC">22 Jul 2023</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><blockquote><p>参考 <a href=https://www.jianshu.com/p/de74baf6fb48>Screeps 制作统计图表 - 简书</a></p></blockquote><p>首先说明: 本文使用 docker 将监控系统部署在自有服务器上，所以先决条件是一台能公网访问的服务器(</p><h2 id=整体流程>整体流程</h2><p><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img@main/20231102131635.png alt=image.png></p><h2 id=具体实现>具体实现</h2><h3 id=记录当前状态存入内存>记录当前状态存入内存</h3><p>在 <a href=https://www.jianshu.com/p/de74baf6fb48>Screeps 制作统计图表 - 简书</a> 中使用的是 <a href=/posts/blog/rust-for-screeps-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B/#memory%20object>memory object</a> 存储系统信息。遗憾的是在 rust 中无法使用 <code>memory</code> 对象，但是 screeps 还有另一个存储信息的地方，那就是 <a href=/posts/blog/rust-for-screeps-2-%E8%87%AA%E5%AE%9A%E4%B9%89%E5%AD%98%E5%82%A8%E6%A8%A1%E5%9E%8B/#raw%20memory>raw memory</a> 。</p><p><code>raw memory</code> 可以存储 10 MB 的序列化后的内容，它由一个个 <code>segment</code> 组成，每个<code>segment</code> 最多存储 100 KB 内容。所以可以指定一段 <code>segment</code> 用于存储当前系统的状态。</p><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>log</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#6a737d>self</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>let</span><span style=color:#fff> </span>status_segement<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>raw_memory::segments<span style=color:#1f2328>();</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span><span style=color:#cf222e>let</span><span style=color:#fff> </span>status<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>Status::get_status<span style=color:#1f2328>();</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>	</span>status_segement<span style=color:#1f2328>.</span>set<span style=color:#1f2328>(</span><span style=color:#0550ae>STATUS_INDEX</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>status<span style=color:#1f2328>.</span>into<span style=color:#1f2328>());</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></div><h3 id=访问内存并解析内存内容>访问内存并解析内存内容</h3><p><a href=https://github.com/booiris/rust-learning/tree/screep_log>GitHub - booiris/rust-learning at screep_log</a></p><h3 id=将信息存储到时序数据库中>将信息存储到时序数据库中</h3><h3 id=使用-grafana-制作图表>使用 Grafana 制作图表</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-bash data-lang=bash><span style=display:flex><span>version: <span style=color:#0a3069>&#39;2&#39;</span>
</span></span><span style=display:flex><span>services:
</span></span><span style=display:flex><span>  sync:
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span><span style=display:flex><span>    build:
</span></span><span style=display:flex><span>      context: ./sync
</span></span><span style=display:flex><span>      dockerfile: Dockerfile
</span></span><span style=display:flex><span>    image: sync:1
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - ./sync/log:/log
</span></span><span style=display:flex><span>    depends_on:
</span></span><span style=display:flex><span>      - influxdb
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a># https://hub.docker.com/_/influxdb 查看参数含义</span>
</span></span><span style=display:flex><span>  influxdb:
</span></span><span style=display:flex><span>    image: influxdb:latest
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - ./influxdb-data:/var/lib/influxdb2
</span></span><span style=display:flex><span>      - ./influxdb-config:/etc/influxdb2
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - <span style=color:#953800>DOCKER_INFLUXDB_INIT_MODE</span><span style=color:#0550ae>=</span>setup
</span></span><span style=display:flex><span>      - <span style=color:#953800>DOCKER_INFLUXDB_INIT_USERNAME</span><span style=color:#0550ae>=</span><span style=color:#0a3069>${</span><span style=color:#953800>username</span><span style=color:#0a3069>}</span>
</span></span><span style=display:flex><span>      - <span style=color:#953800>DOCKER_INFLUXDB_INIT_PASSWORD</span><span style=color:#0550ae>=</span><span style=color:#0a3069>${</span><span style=color:#953800>pwd</span><span style=color:#0a3069>}</span>
</span></span><span style=display:flex><span>      - <span style=color:#953800>DOCKER_INFLUXDB_INIT_ORG</span><span style=color:#0550ae>=</span><span style=color:#0a3069>${</span><span style=color:#953800>org</span><span style=color:#0a3069>}</span>
</span></span><span style=display:flex><span>      - <span style=color:#953800>DOCKER_INFLUXDB_INIT_BUCKET</span><span style=color:#0550ae>=</span><span style=color:#0a3069>${</span><span style=color:#953800>bucket</span><span style=color:#0a3069>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#57606a># https://grafana.com/docs/grafana/latest/setup-grafana/installation/docker/ 查看参数含义</span>
</span></span><span style=display:flex><span>  grafana:
</span></span><span style=display:flex><span>    image: grafana/grafana:latest
</span></span><span style=display:flex><span>    restart: unless-stopped
</span></span><span style=display:flex><span>    ports:
</span></span><span style=display:flex><span>      - <span style=color:#0a3069>&#39;12002:3000&#39;</span>
</span></span><span style=display:flex><span>    volumes:
</span></span><span style=display:flex><span>      - ./grafana-data:/var/lib/grafana
</span></span><span style=display:flex><span>      - ./grafana-provisioning/:/etc/grafana/provisioning
</span></span><span style=display:flex><span>    depends_on:
</span></span><span style=display:flex><span>      - influxdb
</span></span><span style=display:flex><span>    user: <span style=color:#0a3069>&#34;</span><span style=color:#953800>$UID</span><span style=color:#0a3069>:</span><span style=color:#953800>$GID</span><span style=color:#0a3069>&#34;</span>
</span></span><span style=display:flex><span>    environment:
</span></span><span style=display:flex><span>      - <span style=color:#953800>GF_SECURITY_ADMIN_USER</span><span style=color:#0550ae>=</span><span style=color:#0a3069>${</span><span style=color:#953800>GRAFANA_USERNAME</span><span style=color:#0a3069>}</span>
</span></span><span style=display:flex><span>      - <span style=color:#953800>GF_SECURITY_ADMIN_PASSWORD</span><span style=color:#0550ae>=</span><span style=color:#0a3069>${</span><span style=color:#953800>GRAFANA_PASSWORD</span><span style=color:#0a3069>}</span>
</span></span></code></pre></div></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/categories/screeps/>/screeps</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script src=/%20js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script><script>document.addEventListener("DOMContentLoaded",function(){const e=document.getElementById("disqus_thread"),t=new MutationObserver(function(n){n.forEach(function(){const s=e.getElementsByTagName("iframe");if(s.length>1){const n=s[1];for(;e.firstChild;)e.removeChild(e.firstChild);e.appendChild(n),t.disconnect()}})});t.observe(e,{childList:!0,subtree:!0})})</script></body></html>