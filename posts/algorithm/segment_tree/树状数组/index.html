<!doctype html><html lang=en><head><meta charset=utf-8><meta name=generator content="Hugo 0.147.7"><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1"><meta name=author content><meta property="og:url" content="https://booiris.space/posts/algorithm/segment_tree/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/"><link rel=canonical href=https://booiris.space/posts/algorithm/segment_tree/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84/><link rel=apple-touch-icon href=/avatar.svg><link rel=icon href=/avatar.svg><link rel=shortcut href=/avatar.svg><link rel=alternate type=application/atom+xml href=https://booiris.space/index.xml title><script type=application/ld+json>{"@context":"http://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https:\/\/booiris.space\/"},"articleSection":"posts","name":"树状数组","headline":"树状数组","description":" 区间和模板： pub struct Bitree { tree: Vec\u0026lt;i32\u0026gt;, len: usize, } impl Bitree { #[inline] pub fn new(ini: \u0026amp;Vec\u0026lt;i32\u0026gt;) -\u0026gt; Self { let mut res = Bitree { tree: vec![0; ini.len() \u002b 1], len: ini.len(), }; for (index, v) in ini.iter().enumerate() { res.update(index \u002b 1, *v); } res } #[inline] fn lowbit(x: usize) -\u0026gt; usize { return (x as i32 \u0026amp; -(x as i32)) as usize; } fn update(\u0026amp;mut self, index: usize, v: i32) { let mut pos = index; while pos \u0026lt;= self.len { self.tree[pos] \u002b= v; pos \u002b= Self::lowbit(pos); } } fn get(\u0026amp;self, n: usize) -\u0026gt; i32 { let mut res = 0; let mut pos = n; while pos \u0026gt; 0 { res \u002b= self.tree[pos]; pos -= Self::lowbit(pos); } res } \/\/\/ \u0060query\u0060 下标从\u00601\u0060开始 pub fn query(\u0026amp;self, l: usize, r: usize) -\u0026gt; i32 { self.get(r) - self.get(l - 1) } } 查询 $\\log(n)$ ,更新 $\\log(n)$。\n","inLanguage":"en-US","author":"","creator":"","publisher":"","accountablePerson":"","copyrightHolder":"","copyrightYear":"2022","datePublished":"2022-05-03 13:54:29 \u002b0000 UTC","dateModified":"2022-05-03 13:54:29 \u002b0000 UTC","url":"https:\/\/booiris.space\/posts\/algorithm\/segment_tree\/%E6%A0%91%E7%8A%B6%E6%95%B0%E7%BB%84\/","keywords":[]}</script><title>树状数组</title><meta property="og:title" content="树状数组"><meta property="og:type" content="article"><meta property="og:description" content=" 区间和模板： pub struct Bitree { tree: Vec<i32>, len: usize, } impl Bitree { #[inline] pub fn new(ini: &amp;Vec<i32>) -> Self { let mut res = Bitree { tree: vec![0; ini.len() + 1], len: ini.len(), }; for (index, v) in ini.iter().enumerate() { res.update(index + 1, *v); } res } #[inline] fn lowbit(x: usize) -> usize { return (x as i32 & -(x as i32)) as usize; } fn update(&amp;mut self, index: usize, v: i32) { let mut pos = index; while pos <= self.len { self.tree[pos] += v; pos += Self::lowbit(pos); } } fn get(&amp;self, n: usize) -> i32 { let mut res = 0; let mut pos = n; while pos > 0 { res += self.tree[pos]; pos -= Self::lowbit(pos); } res } /// `query` 下标从`1`开始 pub fn query(&amp;self, l: usize, r: usize) -> i32 { self.get(r) - self.get(l - 1) } } 查询 $\log(n)$ ,更新 $\log(n)$。
"><meta name=description content=" 区间和模板： pub struct Bitree { tree: Vec<i32>, len: usize, } impl Bitree { #[inline] pub fn new(ini: &amp;Vec<i32>) -> Self { let mut res = Bitree { tree: vec![0; ini.len() + 1], len: ini.len(), }; for (index, v) in ini.iter().enumerate() { res.update(index + 1, *v); } res } #[inline] fn lowbit(x: usize) -> usize { return (x as i32 & -(x as i32)) as usize; } fn update(&amp;mut self, index: usize, v: i32) { let mut pos = index; while pos <= self.len { self.tree[pos] += v; pos += Self::lowbit(pos); } } fn get(&amp;self, n: usize) -> i32 { let mut res = 0; let mut pos = n; while pos > 0 { res += self.tree[pos]; pos -= Self::lowbit(pos); } res } /// `query` 下标从`1`开始 pub fn query(&amp;self, l: usize, r: usize) -> i32 { self.get(r) - self.get(l - 1) } } 查询 $\log(n)$ ,更新 $\log(n)$。
"><meta property="og:locale" content="cn"><meta property="og:image" content="/avatar.svg"><link rel=stylesheet href=/css/index.min.css><link rel=stylesheet href=/css/flexboxgrid-6.3.1.min.min.css><link href=/%20index.xml rel=alternate type=application/rss+xml title><link rel=preconnect href=https://fonts.gstatic.com><link href="https://fonts.googleapis.com/css?family=Bree+Serif|Bungee+Shade" rel=stylesheet><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css></head><body><article class="post 简体中文" id=article><div class=row><div class=col-xs-12><div class=site-header><header><div class=header-title><a href=/>HELLO WORLD</a></div><div class=header-subtitle>Live long and prosper.</div></header><div class="row end-md header-items"><div class=header-item><a href=/about>About</a></div><div class=header-item><a href=https://github.com/booiris>Github</a></div><div class=header-item><a href=/memos>Memos</a></div></div><div class=row></div><div class=header-line></div></div><header class=post-header><h1 class=post-title>树状数组</h1><div class="row post-desc"><div class=col-xs-6><time class=post-date datetime="2022-05-03 13:54:29 UTC">03 May 2022</time></div><div class=col-xs-6></div></div></header><div class="post-content markdown-body"><img src=https://cdn.jsdelivr.net/gh/booiris-cdn/img/binary_index_tree.svg width=60%><h3 id=区间和模板>区间和模板：</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Bitree</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>tree: <span style=color:#6639ba>Vec</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>i32</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>len: <span style=color:#cf222e>usize</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>impl</span><span style=color:#fff> </span>Bitree<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>#[inline]</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>new</span><span style=color:#1f2328>(</span>ini: <span style=color:#cf222e>&amp;</span><span style=color:#6639ba>Vec</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>i32</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#1f2328>Self</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>res<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>Bitree<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>tree: <span style=color:#1f2328>vec</span><span style=color:#0550ae>!</span><span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#fff> </span>ini<span style=color:#1f2328>.</span>len<span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>],</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>len: <span style=color:#1f2328>ini</span><span style=color:#1f2328>.</span>len<span style=color:#1f2328>(),</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>};</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>for</span><span style=color:#fff> </span><span style=color:#1f2328>(</span>index<span style=color:#1f2328>,</span><span style=color:#fff> </span>v<span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>in</span><span style=color:#fff> </span>ini<span style=color:#1f2328>.</span>iter<span style=color:#1f2328>().</span>enumerate<span style=color:#1f2328>()</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>res<span style=color:#1f2328>.</span>update<span style=color:#1f2328>(</span>index<span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#0550ae>*</span>v<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span>res<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>#[inline]</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>lowbit</span><span style=color:#1f2328>(</span>x: <span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#cf222e>usize</span> <span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>(</span>x<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>i32</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#fff> </span><span style=color:#0550ae>-</span><span style=color:#1f2328>(</span>x<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>i32</span><span style=color:#1f2328>))</span><span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>usize</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>update</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#cf222e>mut</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>index: <span style=color:#cf222e>usize</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>v: <span style=color:#cf222e>i32</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>pos<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>index<span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>while</span><span style=color:#fff> </span>pos<span style=color:#fff> </span><span style=color:#0550ae>&lt;=</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>len<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>]</span><span style=color:#fff> </span><span style=color:#0550ae>+=</span><span style=color:#fff> </span>v<span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>pos<span style=color:#fff> </span><span style=color:#0550ae>+=</span><span style=color:#fff> </span><span style=color:#6a737d>Self</span>::lowbit<span style=color:#1f2328>(</span>pos<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>get</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>n: <span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#cf222e>i32</span> <span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>res<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>pos<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>n<span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>while</span><span style=color:#fff> </span>pos<span style=color:#fff> </span><span style=color:#0550ae>&gt;</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>res<span style=color:#fff> </span><span style=color:#0550ae>+=</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>];</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>pos<span style=color:#fff> </span><span style=color:#0550ae>-=</span><span style=color:#fff> </span><span style=color:#6a737d>Self</span>::lowbit<span style=color:#1f2328>(</span>pos<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span>res<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>/// `query` 下标从`1`开始
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span><span style=color:#fff>    </span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>query</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>l: <span style=color:#cf222e>usize</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>r: <span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#cf222e>i32</span> <span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>get<span style=color:#1f2328>(</span>r<span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#0550ae>-</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>get<span style=color:#1f2328>(</span>l<span style=color:#fff> </span><span style=color:#0550ae>-</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>)</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></div><p>查询 $\log(n)$ ,更新 $\log(n)$。</p><h3 id=区间最值模版>区间最值模版:</h3><div class=highlight><pre tabindex=0 style=background-color:#fff;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-rust data-lang=rust><span style=display:flex><span><span style=color:#cf222e>use</span><span style=color:#fff> </span>std::cmp::<span style=color:#0550ae>*</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>struct</span> <span style=color:#1f2328>Bitree</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>tree: <span style=color:#6639ba>Vec</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>i32</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>val: <span style=color:#6639ba>Vec</span><span style=color:#0550ae>&lt;</span><span style=color:#cf222e>i32</span><span style=color:#0550ae>&gt;</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span>len: <span style=color:#cf222e>usize</span><span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#cf222e>impl</span><span style=color:#fff> </span>Bitree<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>#[inline]</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>new</span><span style=color:#1f2328>(</span>len: <span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#1f2328>Self</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span>Bitree<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>tree: <span style=color:#1f2328>vec</span><span style=color:#0550ae>!</span><span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#fff> </span>len<span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>],</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>val: <span style=color:#1f2328>vec</span><span style=color:#0550ae>!</span><span style=color:#1f2328>[</span><span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#fff> </span>len<span style=color:#fff> </span><span style=color:#0550ae>+</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>],</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>len<span style=color:#1f2328>,</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#57606a>#[inline]</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>lowbit</span><span style=color:#1f2328>(</span>x: <span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#cf222e>usize</span> <span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>return</span><span style=color:#fff> </span><span style=color:#1f2328>(</span>x<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>i32</span><span style=color:#fff> </span><span style=color:#0550ae>&amp;</span><span style=color:#fff> </span><span style=color:#0550ae>-</span><span style=color:#1f2328>(</span>x<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>i32</span><span style=color:#1f2328>))</span><span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>usize</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>update</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#cf222e>mut</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>index: <span style=color:#cf222e>usize</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>v: <span style=color:#cf222e>i32</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>pos<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>index<span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>val<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>]</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>v<span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>while</span><span style=color:#fff> </span>pos<span style=color:#fff> </span><span style=color:#0550ae>&lt;=</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>len<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>]</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>val<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>];</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#cf222e>let</span><span style=color:#fff> </span>low<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#6a737d>Self</span>::lowbit<span style=color:#1f2328>(</span>pos<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>i<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#cf222e>while</span><span style=color:#fff> </span>i<span style=color:#fff> </span><span style=color:#0550ae>&lt;</span><span style=color:#fff> </span>low<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>]</span><span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>max<span style=color:#1f2328>(</span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>pos<span style=color:#1f2328>],</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>pos<span style=color:#fff> </span><span style=color:#0550ae>-</span><span style=color:#fff> </span>i<span style=color:#1f2328>]);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span>i<span style=color:#fff> </span><span style=color:#0550ae>&lt;&lt;=</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>pos<span style=color:#fff> </span><span style=color:#0550ae>+=</span><span style=color:#fff> </span><span style=color:#6a737d>Self</span>::lowbit<span style=color:#1f2328>(</span>pos<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#0a3069>/// `query` 下标从`1`开始
</span></span></span><span style=display:flex><span><span style=color:#0a3069></span><span style=color:#fff>    </span><span style=color:#cf222e>pub</span><span style=color:#fff> </span><span style=color:#cf222e>fn</span> <span style=color:#6639ba>query</span><span style=color:#1f2328>(</span><span style=color:#0550ae>&amp;</span><span style=color:#6a737d>self</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>l: <span style=color:#cf222e>i32</span><span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>r: <span style=color:#cf222e>i32</span><span style=color:#1f2328>)</span><span style=color:#fff> </span>-&gt; <span style=color:#cf222e>i32</span> <span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>let</span><span style=color:#fff> </span><span style=color:#cf222e>mut</span><span style=color:#fff> </span>res<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span><span style=color:#0550ae>0</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span>l<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>max<span style=color:#1f2328>(</span><span style=color:#0550ae>1</span><span style=color:#1f2328>,</span><span style=color:#fff> </span>l<span style=color:#1f2328>);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#cf222e>while</span><span style=color:#fff> </span>r<span style=color:#fff> </span><span style=color:#0550ae>&gt;=</span><span style=color:#fff> </span>l<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>res<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>max<span style=color:#1f2328>(</span>res<span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>val<span style=color:#1f2328>[</span>r<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>usize</span><span style=color:#1f2328>]);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span>r<span style=color:#fff> </span><span style=color:#0550ae>-=</span><span style=color:#fff> </span><span style=color:#0550ae>1</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#cf222e>while</span><span style=color:#fff> </span>r<span style=color:#fff> </span><span style=color:#0550ae>-</span><span style=color:#fff> </span><span style=color:#6a737d>Self</span>::lowbit<span style=color:#1f2328>(</span>r<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>i32</span><span style=color:#fff> </span><span style=color:#0550ae>&gt;=</span><span style=color:#fff> </span>l<span style=color:#fff> </span><span style=color:#1f2328>{</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span>res<span style=color:#fff> </span><span style=color:#0550ae>=</span><span style=color:#fff> </span>max<span style=color:#1f2328>(</span>res<span style=color:#1f2328>,</span><span style=color:#fff> </span><span style=color:#6a737d>self</span><span style=color:#1f2328>.</span>tree<span style=color:#1f2328>[</span>r<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>usize</span><span style=color:#1f2328>]);</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>                </span>r<span style=color:#fff> </span><span style=color:#0550ae>-=</span><span style=color:#fff> </span><span style=color:#6a737d>Self</span>::lowbit<span style=color:#1f2328>(</span>r<span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>usize</span><span style=color:#1f2328>)</span><span style=color:#fff> </span><span style=color:#cf222e>as</span><span style=color:#fff> </span><span style=color:#cf222e>i32</span><span style=color:#1f2328>;</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>            </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>        </span>res<span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff>    </span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span><span style=display:flex><span><span style=color:#fff></span><span style=color:#1f2328>}</span><span style=color:#fff>
</span></span></span></code></pre></div><p>查询 $\log(n)$ ,更新 $\log(n)^2$。</p></div><div class="row middle-xs"><div class=col-xs-12><div class=post-tags><a href=/categories/algorithm/>/algorithm</a></div><div class=post-tags><a href=/categories/segment_tree/>/segment_tree</a></div></div></div><div class=row><div class=col-xs-12></div></div><div style=height:50px></div><div class=site-footer></div></div></div></article><script src=/js/lazyload.min.js></script><script>var lazyImage=new LazyLoad({container:document.getElementById("article")})</script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js></script><script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js></script><script>document.addEventListener("DOMContentLoaded",function(){renderMathInElement(document.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],throwOnError:!1})})</script></body></html>