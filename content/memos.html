<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/versions/bulma-no-dark-mode.min.css">
    <link rel="stylesheet" href="/css/index.min.css">
    <link rel="stylesheet" href="/css/flexboxgrid-6.3.1.min.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.umd.js"
        type="application/javascript"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/ui@5.0/dist/fancybox/fancybox.css" />
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js" type="application/javascript"></script>
    <style>
        .markdown-content p {
            margin-bottom: 1em;
        }

        .markdown-content pre {
            background-color: #f5f5f5;
            padding: 1em;
            border-radius: 4px;
            overflow-x: auto;
        }

        .markdown-content code {
            background-color: #f5f5f5;
            padding: 0.2em 0.4em;
            border-radius: 3px;
        }

        .markdown-content blockquote {
            border-left: 4px solid #dbdbdb;
            padding-left: 1em;
            color: #474747;
        }

        .thumbnail-img {
            max-width: 200px;
            max-height: 200px;
        }
    </style>
</head>

<body>
    <div id="memos-container">
    </div>

    <div class="modal" id="error-modal">
        <div class="modal-background"></div>
        <div class="modal-content">
            <div class="notification is-danger">
                <button class="delete" aria-label="close"></button>
                <p id="error-message" style="margin-bottom: 0px;">get memos failed</p>
            </div>
        </div>
    </div>

    <script>
        const host = 'booirisapi.asia:8443';
        const errorModal = document.getElementById('error-modal');
        const errorMessage = document.getElementById('error-message');
        let nextPageToken = '';
        let isLoading = false;

        document.querySelector('.modal .delete').addEventListener('click', () => {
            errorModal.classList.remove('is-active');
        });

        document.querySelector('.modal-background').addEventListener('click', () => {
            errorModal.classList.remove('is-active');
        });

        async function fetchMemos(isLoadMore = false) {
            if (isLoading) return;
            isLoading = true;

            try {
                const url = new URL(`https://${host}/api/v1/memos`);
                url.searchParams.append('pageSize', '5');
                if (isLoadMore && nextPageToken) {
                    url.searchParams.append('pageToken', nextPageToken);
                }

                const response = await fetch(url, {
                    mode: 'cors'
                });
                const data = await response.json();
                nextPageToken = data.nextPageToken || '';
                displayMemos(data, isLoadMore);
            } catch (error) {
                errorModal.classList.add('is-active');
            } finally {
                isLoading = false;
            }
        }

        function displayMemos(data, isLoadMore = false) {
            const container = document.getElementById('memos-container');
            if (data && data.memos) {
                if (!isLoadMore) {
                    container.innerHTML = '';
                }
                data.memos.forEach(memo => {
                    const memoBox = document.createElement('div');
                    memoBox.className = 'box';
                    memoBox.style.boxShadow = 'none';
                    memoBox.style.border = '3px solid #0A0A0A';
                    memoBox.style.marginBottom = '1rem';

                    const content = document.createElement('div');
                    content.className = 'markdown-content';
                    content.innerHTML = marked.parse(memo.content);

                    var imgs = [];
                    for (let res of memo.resources) {
                        if (res.type?.includes('image/')) {
                            imgs.push(res);
                        }
                    }
                    var cell = '';
                    if (imgs.length > 0) {
                        for (let img of imgs) {
                            if (img.externalLink?.length > 0) {
                                cell += `<a href="${img.externalLink}" data-fancybox><img class="thumbnail-img" src="${img.externalLink}"></a>`;
                            } else {
                                const fullUrl = `https://${host}/file/${img.name}/${img.filename}`;
                                cell += `<a href="${fullUrl}" data-fancybox><img class="thumbnail-img" src="${fullUrl}?thumbnail=1"></a>`;
                            }
                        }
                    }
                    const img = document.createElement('div');
                    img.className = 'grid is-gap-1';
                    img.innerHTML = cell;

                    const time = document.createElement('p');
                    time.className = 'is-size-6 has-text-grey';
                    time.style.marginBottom = '0';
                    time.style.marginTop = '10px';
                    time.textContent = new Date(memo.displayTime).toLocaleString('zh-CN', {
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: false
                    });

                    memoBox.appendChild(content);
                    memoBox.appendChild(img);
                    memoBox.appendChild(time);
                    container.appendChild(memoBox);
                });
            }
        }

        Fancybox.bind("[data-fancybox]", {
        });

        document.addEventListener('DOMContentLoaded', () => {
            fetchMemos();

            window.addEventListener('scroll', () => {
                if ((window.innerHeight + window.scrollY) >= document.body.offsetHeight - 400) {
                    if (nextPageToken) {
                        fetchMemos(true);
                    }
                }
            });
        });
    </script>
</body>

</html>